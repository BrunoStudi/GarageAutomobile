{% extends is_granted('IS_AUTHENTICATED_FULLY') ? 'basebackoffice.html.twig' : 'base.html.twig' %}

{% block title %}Voiture index{% endblock %}

{% block body %}

    <style>
        /* Custom CSS for red range slider */
        .slider-red .noUi-connect {
            background: #D81324; /* Utilise la couleur rouge #D81324 pour le curseur de la plage de valeurs */
        }
        /* Center the h1 element */
        h1 {
            text-align: center;
            margin-top: 30px; /* Add some margin bottom */
        }
    </style>

    <h1 class="mb-5">Voitures à vendre</h1>

    <!-- Voitures Start -->
    <div class="container-xxl py-5">
        <div class="container">
            <div class="text-center wow fadeInUp" data-wow-delay="0.1s"></div>

            {% if not is_granted('ROLE_EMPLOYE') %}
                <!-- Range Slider -->
                <div class="mb-3">
                    <div id="price-range" class="slider-red"></div>
                    <!-- Ajouter la classe personnalisée pour le curseur rouge -->
                    <div id="price-range-values" class="text-center mt-2">
                        Min:
                        <span id="min-value"></span>&euro; | Max:
                        <span id="max-value"></span>&euro;
                        <!-- Add euro symbol -->
                    </div>
                </div>
                <!-- End Range Slider -->
            {% endif %}

            <div class="row g-4" id="car-list">
                <!-- Include the car items -->
                {% for voiture in voitures %}
                    <div class="col-lg-4 col-md-6 col-sm-12 wow fadeInUp" data-wow-delay="0.{{ loop.index }}">
                        <div class="team-item">
                            <div class="position-relative overflow-hidden">
                                <div class="img-container" style="height: 300px; width: 100%; overflow: hidden;">
                                    <!-- Set fixed dimensions for the image container and hide overflow -->
                                    {% if voiture.images|length > 0 %}
                                        <img src="{{ asset('uploads/voiture/' ~ voiture.images[0].name ) }}" alt="{{ voiture.Titre }}" class="img-thumbnail" style="object-fit: cover; width: 100%; height: 100%;">
                                    <!-- Set image size to cover the container -->
                                    {% endif %}
                                </div>
                                <div class="team-overlay position-absolute start-0 top-0 w-100 h-100">
                                    <a href="{{ path('voiture_details', {'id': voiture.id}) }}" class="btn btn-primary" style="border-radius: 10px;">Plus de détails</a>
                                </div>
                            </div>
                            <div class="bg-light text-center p-4">
                                <h5 class="fw-bold mb-3">Marque & Modele : {{ voiture.Titre }}</h5>
                                <!-- Add any other details you want to display here -->
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <!-- Voitures End -->

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wow/1.1.2/wow.min.js"></script>
    <!-- Include WOW.js library -->
    <!-- Custom script for initializing the slider and handling AJAX request -->

    <script>
        $(document).ready(function () {
            var slider = document.getElementById('price-range');
            var minValue = document.getElementById('min-value');
            var maxValue = document.getElementById('max-value');
            var previousValues = [0, 100000]; // Initialize previous values
            var delayTimer; // Initialize timer variable for delay
            var sliderInteracted = false; // Flag to track slider interaction

            noUiSlider.create(slider, {
                start: previousValues, // Initial values
                connect: true,
                range: {
                    'min': 0,
                    'max': 100000
                }
            });

            slider.noUiSlider.on('update', function (values, handle) { // Format values with space every three digits from right to left
                minValue.innerText = formatNumber(values[0]);
                maxValue.innerText = formatNumber(values[1]);
            });

            function formatNumber(number) {
                return parseFloat(number).toLocaleString('fr-FR');
            }

            slider.noUiSlider.on('change', function (values, handle) { // Set the flag to true when slider is interacted with
                if (! sliderInteracted) {
                    sliderInteracted = true;
                }

                // Clear previous delay timer
                clearTimeout(delayTimer);

                // Set new delay timer for 1 second only if slider is interacted with
                if (sliderInteracted) {
                    delayTimer = setTimeout(function () {
                        if (values[0] !== previousValues[0] || values[1] !== previousValues[1]) {
                            $.ajax({
                                url: "{{ path('filter_cars') }}",
                                method: "POST",
                                data: {
                                    minPrice: values[0],
                                    maxPrice: values[1]
                                },
                                success: function (response) {
                                    updateCarList(response);
                                    new WOW().init(); // Initialize WOW.js for animation
                                },
                                error: function (xhr, status, error) {
                                    console.error(error);
                                }
                            });

                            previousValues = [
                                values[0], values[1]
                            ]; // Update previous values
                        }
                    }, 1000); // Set delay to 1 second
                }
            });

            function updateCarList(cars) {
                var carList = $('#car-list');
                carList.empty(); // Clear existing car list

                cars.forEach(function (car) {
                    var carItem = `
                        <div class="col-lg-4 col-md-6 col-sm-12 wow fadeInUp">
                            <div class="team-item">
                                <div class="position-relative overflow-hidden">
                                    <div class="img-container" style="height: 300px; width: 100%; overflow: hidden;">
                                        <img src="${car.imageUrl}" alt="${car.Titre}" class="img-thumbnail" style="object-fit: cover; width: 100%; height: 100%;">
                                    </div>
                                    <div class="team-overlay position-absolute start-0 top-0 w-100 h-100">
                                        <a href="#" data-details-url="/voiture/details/${car.id}" class="btn btn-primary details-btn" style="border-radius: 10px;">Plus de détails</a>
                                    </div>
                                </div>
                                <div class="bg-light text-center p-4">
                                    <h5 class="fw-bold mb-3">Marque & Modele: ${car.Titre}</h5>
                                </div>
                            </div>
                        </div>`;
                    carList.append(carItem);
                });

                // Attach event listener to dynamically created buttons
                $('.details-btn').click(function (e) {
                    e.preventDefault();
                    var detailsUrl = $(this).data('details-url');
                    window.location.href = detailsUrl;
                });
            }
        });
    </script>

{% endblock %}
